name: CLI release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            asset_name: main.bin
            target_name: code-context
          - os: windows-latest
            asset_name: main.exe
            target_name: code-context.exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - id: build_core_linux
        if: runner.os == 'Linux'
        name: Build core (Linux)
        working-directory: ./core
        run: |
          uv sync --no-dev
          uv build
          cd dist
          wheel_file=$(ls -t *.whl | head -n1)
          echo "wheel_file=$(basename "$wheel_file")" >> "$GITHUB_OUTPUT"

      - id: build_core_windows
        if: runner.os == 'Windows'
        name: Build core (Windows)
        working-directory: ./core
        shell: pwsh
        run: |
          uv sync --no-dev
          uv build
          $w = Get-ChildItem .\dist\*.whl | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          $leaf = Split-Path $w.FullName -Leaf
          "wheel_file=$leaf" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Generate requirements.txt
        working-directory: ./cli
        run: |
          uv export --no-dev --no-emit-package core > requirements.txt

      - name: Install requirements (Linux)
        if: runner.os == 'Linux'
        run: |
          pip install "./core/dist/${{ steps.build_core_linux.outputs.wheel_file }}"
          pip install -r "./cli/requirements.txt"

      - name: Install requirements (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          pip install ".\core\dist\${{ steps.build_core_windows.outputs.wheel_file }}"
          pip install -r ".\cli\requirements.txt"

      - name: Build Executable with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ./cli/src/main.py
          mode: onefile
          output-dir: build

      - name: Upload release asset (Linux)
        if: runner.os == 'Linux'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          FILE="build/${{ matrix.asset_name }}"
          if [ ! -f "$FILE" ]; then
            echo "Error: $FILE not found"
            exit 1
          fi
          mv "$FILE" "${{ matrix.target_name }}"
          gh release upload "${{ github.event.release.tag_name }}" "./${{ matrix.target_name }}" --clobber --repo "${{ github.repository }}"

      - name: Upload release asset (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $file = Join-Path $PWD "build\${{ matrix.asset_name }}"
          if (!(Test-Path $file)) {
            Write-Error "Error: $file not found"
            exit 1
          }
          $target = Join-Path $PWD "${{ matrix.target_name }}"
          Move-Item -Force $file $target
          gh release upload "${{ github.event.release.tag_name }}" "$target" --clobber --repo "${{ github.repository }}"
